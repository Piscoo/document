# Frontend

## JavaScript

### JavaScript代码运行的各个阶段

以V8引擎为例，在V8引擎中JavaScript代码的运行过程主要分成三个阶段。

1. **语法分析阶段。** 该阶段会对代码进行语法分析，检查是否有语法错误（SyntaxError），如果发现语法错误，会在控制台抛出异常并终止执行。
2. **编译阶段。** 该阶段会进行执行上下文（Execution Context）的创建，包括创建变量对象、建立作用域链、确定this的指向等。每进入一个不同的运行环境时，V8引擎都会创建一个新的执行上下文。
3. **执行阶段。**  将编译阶段中创建的执行上下文压入调用栈，并成为正在运行的执行上下文，代码执行结束后，将其弹出调用栈。

#### 宏任务和微任务

事件循环中的异步回调队列中有两种：宏任务（MacroTask）和微任务（MicroTask）队列。

*什么是宏任务和微任务呢？*

- 宏任务：包括script全部代码、`serTimeout`、`setInterval`、`setImmediate`(Node.js)、`requestAnimationFrame`(浏览器）、I/O操作、UI渲染（浏览器），这些代码执行便是宏任务。
- 微任务：包括`process.nextTick`(Node.js)、`Promise`、`MutationObserver`，这些代码的执行便是微任务。

为什么要将异步任务分为宏任务和微任务呢？这是为了避免回调队列中等待执行的异步任务（宏任务）过多，导致某些异步任务（微任务）的等待时间过长。在每个宏任务执行完成之后，会先将微任务队列中的任务执行完毕，再执行下一个宏任务。

在浏览器的异步回调队列中，宏任务和微任务的执行过程如下：

 	1. 宏任务队列一次只从队列中取一个任务执行，执行完后就去执行微任务队列中的任务。
 	2. 微任务队列中所有的任务都会被依次取出来执行，直到微任务队列为空。
 	3. 在执行完所有的微任务之后，执行下一个宏任务之前，浏览器会执行UI渲染操作、更新界面。

#### 页面请求过程

当我们在浏览器输入网页地址，按下回车键后，浏览器的处理过程如下：

	1. DNS域名解析（此处涉及DNS的寻址过程），找到网页的存放服务器；
	2. 浏览器与服务器建立TCP连接；
	3. 浏览器发起HTTP请求；
	4. 服务器响应HTTP请求，返回该页面的HTML内容；
	5. 浏览器解析HTML代码，并请求HTML代码中的资源（如JavaScript，CSS，图片等，此处可能涉及HTTP缓存）；
	6. 浏览器对页面进行渲染呈现给用户（此处涉及浏览器的渲染原理）。

##### DNS解析

DNS的全称是 Domain Name System，又称域名系统，它负责把`www.baidu.com`这样的域名地址翻译成一个IP（比如`14.18.180.206`），而客户端与服务器建立TCP连接需要通过IP通信。

让客户端和服务器连接并不是靠域名进行，在网络中每个终端之间实现连接和通信是通过一个唯一的IP地址来完成。在建立TCP连接前，我们需要找到建立连接的服务器，DNS的解析过程可以让用户通过域名找到存放文件的服务器。

DNS解析过程会进行递归查询，分别依次尝试以下途径，按顺序地获取该域名对应的IP地址。

- 浏览器缓存
- 系统缓存（用户操作系统Hosts文件）
- 路由器缓存
- 互联网服务提供商DNS缓存（联通、移动、电信等互联网服务提供商的DNS缓存服务器）
- 根域名服务器
- 顶级域名服务器
- 主域名服务器

DNS解析过程会根据上述步骤进行递归查询，如果当前步骤没查到，则自动跳转到下一步骤通过下一个DNS服务器进行查找。如果最终依然没找到，浏览器便会将页面响应为打开失败。



##### TCP连接的建立

TCP连接的建立过程比较偏通信底层，在前端日常开发过程中不容易接触到。但有时候我们需要优化应用的加载耗时、请求耗时或是定位一些偏底层的问题（请求异常、HTTP连接无法建立等），都会或多或少依赖这些偏底层的知识。

###### TCP/UDP的区别、TCP的三次握手和四次挥手

- TCP协议提供可靠传输服务，UDP协议则可以更快地进行通信；
- 三次握手：指TCP连接的建立过程，该过程中客户端和服务端总共需要发送三个包，从而确认连接存在；
- 四次挥手：指TCP连接的断开过程，该过程中需要客户端和服务端总共发送四个包，从而确认连接关闭，

当客户端和服务端建立起TCP连接之后，HTTP服务器会监听客户端发起的请求，此时客户端会发起HTTP请求。



##### 浏览器中页面渲染的过程

###### 浏览器的内部结构

从结构上来说，浏览器主要包括了八个子系统：用户界面、浏览器引擎、渲染引擎、网络子系统、JavaScript解释器、XML解释器、显示后端、数据持久性子系统。

这些子系统组合构成了我们的浏览器。页面的加载和渲染过程，离不开网络子系统、渲染引擎、JavaScript解释器和浏览器引擎。

###### Chrome多进程架构

Chrome浏览器采用的多进程架构，主要包括四个进程：

1. 浏览器进程： 选项卡之外的所有内容都有浏览器进程处理，浏览器进程则主要用于控制和处理用户可见的UI部分（包括地址栏，书签，后退和前进按钮）和用户不可见的隐藏部分（例如网络请求和文件访问）。
2. GPU进程：该进程用于完成图像处理任务，同时还支持分解成多个进程进行处理。
3. 渲染器进程：Chrome浏览器中支持多个选项卡，其中每个选项卡在单独的渲染器进程中运行，渲染器进程主要用于控制和处理选项卡中的网站内容显示。
4. 插件进程：管理Chrome浏览器中的各个插件。

##### 浏览器中页面的渲染过程

首先，我们将浏览器中页面的渲染过程分为两部分。

- 页面导航：用户输入URL，浏览器进程进行请求和准备处理。
- 页面渲染：获取到相关资源后，渲染器进程负责选项卡内部的渲染处理。

1. 页面导航过程

当用户在地址栏输入内容时，浏览器内部会进行以下处理。

- 首先浏览器进程的UI线程会进行处理：如果是URL，则会发起网络请求来获取网站内容；如果不是，则进入搜索引擎。

- 如果需要发起网络请求，请求过程由网络线程来完成。HTTP请求响应如果是HTML文件，则将数据传递到渲染器进程；如果是其他文件则意味着这是下载请求，此时会将数据传递到下载管理器。

- 如果请求响应为HTML内容，此时浏览器应导航到请求站点，网络线程便通知UI线程数据准备就绪。

- 接下来，UI线程会寻找一个渲染器进程来进行网页渲染。当数据和渲染器进程都准备好后，HTML数据通过IPC从浏览器进程传递到渲染器进程中。

- 渲染器进程接收HTML数据后，将开始加载资源并渲染页面。

- 渲染器进程完成渲染后，通过IPC通知浏览器进程页面已加载。

2. 页面渲染过程

   整体上，渲染器进程渲染页面的流程基本如下：

   - 解析(Parser)：解析HTML/CSS/JavaScript 代码
   - 布局(Layout)：定位坐标和大小、是否换行、各种position/overflow/z-index属性等计算。
   - 绘制(Paint)：判断元素渲染层级顺序
   - 光栅化(Raster)：将计算后的信息转换为屏幕上的像素。



1. 解析

渲染器进程的主线程会解析以下内容：

- 解析HTM L内容，产生一个DOM节点树；
- 解析CSS，产生CSS规则树；
- 解析JavaScript脚本，由于JavaScript脚本可以通过DOM API 和 CSSOM API 来操作DOM节点树和CSS规则树，因此该过程中会等待JavaScript运行完成才继续解析HTML。

解析完成后，我们得到了DOM节点树和CSS规则树，布局过程便是通过DOM树和CSS规则树来构造渲染树。

2. 布局

